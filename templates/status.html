{% extends "base.html" %}

{% block title %}Processing Status{% endblock %}

{% block header_title %}Processing Status{% endblock %}

{% block extra_css %}
<style>
    .session-item { background: #fff; border: 1px solid #eee; margin-bottom: 1rem; border-radius: 8px; overflow: hidden; }
    .session-header { padding: 1rem; display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; cursor: pointer; }
    .session-header:hover { background: #f1f3f5; }
    .session-name { font-weight: 600; font-size: 1.1rem; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
    .badge-waiting { background: #e2e3e5; color: #383d41; }
    .badge-progress { background: #cce5ff; color: #004085; }
    .badge-complete { background: #d4edda; color: #155724; }
    
    .progress-track { flex-grow: 1; height: 1.5rem; background: #e9ecef; border-radius: 4px; margin: 0 1.5rem; overflow: hidden; }
    .progress-fill { height: 100%; background: #007bff; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9rem; font-weight: 600; }
    
    .session-details { display: none; padding: 1rem; border-top: 1px solid #eee; }
    .session-details.open { display: block; }
    
    /* ACTIONS BAR */
    .actions-bar { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .btn-action { padding: 8px 12px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #555; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
    .btn-action:hover { background: #f8f9fa; border-color: #bbb; color: #333; }
    .btn-action.danger:hover { background: #fff5f5; border-color: #ffbdc3; color: #dc3545; }

    .file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
    .file-card { border: 1px solid #dee2e6; padding: 0.75rem; border-radius: 4px; display: flex; align-items: center; cursor: pointer; transition: all 0.2s; background: #fff; }
    .file-card:hover { border-color: #007bff; color: #007bff; background: #f8f9fa; }
    .file-card i { margin-right: 0.75rem; font-size: 1.2rem; }
    .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.9rem; }

    /* Modal Styles */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-container { background: white; width: 80%; height: 85%; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .modal-header { padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-weight: bold; font-size: 1.1rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
    .modal-close:hover { color: #000; }
    .modal-body { flex-grow: 1; padding: 0; background: #f8f9fa; }
    iframe { width: 100%; height: 100%; border: none; display: block; }
</style>
{% endblock %}

{% block content %}
    <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

    <div id="session-container">
        <p style="text-align:center; color:#666;">Loading sessions...</p>
    </div>

    <div id="fileModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-container">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">File Viewer</span>
                <button class="modal-close" onclick="closeModal(event)">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="fileViewer" src=""></iframe>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // --- Actions Logic ---
    function triggerAction(action, sessionName) {
        if (!confirm("Are you sure? This will delete existing files and restart processing for this step.")) return;

        const csrf = document.getElementById('csrf_token').value;
        const formData = new FormData();
        formData.append('csrf_token', csrf);

        fetch(`/api/action/${action}/${sessionName}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert("Action triggered! Scribble will pick up the changes in the next cycle.");
                updateSessions(); // Refresh UI immediately
            } else {
                alert("Error: " + data.error);
            }
        })
        .catch(err => alert("System Error: " + err));
    }

    // --- Modal Logic ---
    function openViewer(url, filename) {
        document.getElementById('modalTitle').innerText = filename;
        document.getElementById('fileViewer').src = url;
        document.getElementById('fileModal').style.display = 'flex';
    }

    function closeModal(e) {
        if (e.target === document.getElementById('fileModal') || e.target.classList.contains('modal-close')) {
            document.getElementById('fileModal').style.display = 'none';
            document.getElementById('fileViewer').src = 'about:blank';
        }
    }

    // --- Status Logic ---
    function getStatusClass(status) {
        if (status === 'Complete') return 'badge-complete';
        if (status === 'Waiting') return 'badge-waiting';
        return 'badge-progress';
    }

    function getFileIcon(filename) {
        if (filename.endsWith('.log')) return 'fa-file-code';
        if (filename.endsWith('.json')) return 'fa-file-code';
        if (filename.endsWith('.txt')) return 'fa-file-alt';
        return 'fa-file-audio';
    }

    function updateSessions() {
        const openSessions = Array.from(document.querySelectorAll('.session-details.open'))
            .map(el => el.getAttribute('data-session'));

        fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('session-container');
                if (data.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;">No sessions found.</p>';
                    return;
                }

                const html = data.map(session => {
                    const isOpen = openSessions.includes(session.name) ? 'open' : '';
                    
                    return `
                    <div class="session-item">
                        <div class="session-header" onclick="this.nextElementSibling.classList.toggle('open')">
                            <div class="session-name">
                                <i class="fas fa-folder"></i> ${session.name}
                            </div>
                            ${session.status === 'In Progress' || session.status === 'Summarizing' ? `
                            <div class="progress-track">
                                <div class="progress-fill" style="width: ${session.progress}%">${session.progress}%</div>
                            </div>
                            ` : ''}
                            <span class="status-badge ${getStatusClass(session.status)}">${session.status}</span>
                            <i class="fas fa-chevron-down" style="margin-left: 1rem; color: #ccc;"></i>
                        </div>
                        
                        <div class="session-details ${isOpen}" data-session="${session.name}">
                            <div class="actions-bar">
                                <button class="btn-action danger" onclick="triggerAction('retry_whisper', '${session.name}')">
                                    <i class="fas fa-redo"></i> Re-Transcribe Audio
                                </button>
                                <button class="btn-action" onclick="triggerAction('retry_transcript', '${session.name}')">
                                    <i class="fas fa-file-alt"></i> Re-Build Transcript
                                </button>
                                <button class="btn-action" onclick="triggerAction('retry_llm', '${session.name}')">
                                    <i class="fas fa-robot"></i> Re-Generate & Post Recap
                                </button>
                            </div>

                            <h5><i class="fas fa-copy"></i> Session Files</h5>
                            <div class="file-list">
                                ${session.files.map(f => `
                                    <div class="file-card" onclick="openViewer('/files/${session.name}/${f}', '${f}')">
                                        <i class=\"far ${getFileIcon(f)}\"></i>
                                        <span class="file-name">${f}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `}).join('');
                container.innerHTML = html;
            });
    }

    updateSessions();
    setInterval(updateSessions, 5000);
</script>
{% endblock %}