# Use NVIDIA CUDA 12.2 Base Image (Ubuntu 22.04)
FROM nvidia/cuda:12.2.0-runtime-ubuntu22.04

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install Python and System Dependencies
RUN apt-get update
RUN apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    ffmpeg \
    git \
    curl \
    tzdata \
    jq

# Clean up
RUN rm -rf /var/lib/apt/lists/*

# Set up working directory
WORKDIR /app

# Install Python Dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
RUN rm requirements.txt

# Copy Application Code
COPY --chmod=775 app.py .
COPY --chmod=775 config.py .
COPY --chmod=775 database.py .
COPY --chmod=775 db_migrate.py .
COPY --chmod=775 llm_engine.py .
COPY --chmod=775 models.py .
COPY --chmod=775 start.sh .
COPY --chmod=775 transcription_engine.py .
COPY --chmod=775 worker.py .
COPY templates .

# Environment Variables
ENV PUID=1000
ENV PGID=1000
ENV TZ=UTC

# Make start script executable
RUN chmod +x start.sh

# Create data directories
RUN mkdir -p /data/input /data/scripts /data/archive

# Expose the WebUI port
EXPOSE 13131

# Command
CMD ["./start.sh"]